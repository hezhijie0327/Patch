From aae6e4d79c971f6b4615f8e7f122de5e49be541b Mon Sep 17 00:00:00 2001
From: Zhijie He <hezhijie0327@hotmail.com>
Date: Thu, 25 Nov 2021 22:45:39 +0800
Subject: [PATCH] Change the default configuration template

---
 internal/dhcpd/http.go            |  2 +-
 internal/dnsforward/dnsforward.go |  8 +++---
 internal/home/config.go           | 46 +++++++++++++++----------------
 internal/home/dns.go              |  2 +-
 internal/home/filter.go           |  5 +---
 5 files changed, 30 insertions(+), 33 deletions(-)

diff --git a/internal/dhcpd/http.go b/internal/dhcpd/http.go
index e016dee8..b177bbb3 100644
--- a/internal/dhcpd/http.go
+++ b/internal/dhcpd/http.go
@@ -537,7 +537,7 @@ func (s *Server) handleDHCPRemoveStaticLease(w http.ResponseWriter, r *http.Requ
 
 const (
 	// DefaultDHCPLeaseTTL is the default time-to-live for leases.
-	DefaultDHCPLeaseTTL = uint32(timeutil.Day / time.Second)
+	DefaultDHCPLeaseTTL = uint32(timeutil.Day / 24 / time.Second)
 	// DefaultDHCPTimeoutICMP is the default timeout for waiting ICMP responses.
 	DefaultDHCPTimeoutICMP = 1000
 )
diff --git a/internal/dnsforward/dnsforward.go b/internal/dnsforward/dnsforward.go
index a62a6614..6bfdc21e 100644
--- a/internal/dnsforward/dnsforward.go
+++ b/internal/dnsforward/dnsforward.go
@@ -26,7 +26,7 @@ import (
 )
 
 // DefaultTimeout is the default upstream timeout
-const DefaultTimeout = 10 * time.Second
+const DefaultTimeout = 1 * time.Second
 
 // defaultClientIDCacheCount is the default count of items in the LRU client ID
 // cache.  The assumption here is that there won't be more than this many
@@ -39,12 +39,12 @@ const (
 )
 
 var defaultDNS = []string{
-	"https://dns10.quad9.net/dns-query",
+	"https://dns.alidns.com:443/dns-query",
 }
-var defaultBootstrap = []string{"9.9.9.10", "149.112.112.10", "2620:fe::10", "2620:fe::fe:10"}
+var defaultBootstrap = []string{"tls://[223.5.5.5]:853", "tls://[223.6.6.6]:853", "tls://[2400:3200::1]:853", "tls://[2400:3200:baba::1]:853"}
 
 // Often requested by all kinds of DNS probes
-var defaultBlockedHosts = []string{"version.bind", "id.server", "hostname.bind"}
+var defaultBlockedHosts = []string{"|hostname.bind^", "|id.server^", "|version.bind^", "|version.server^"}
 
 var webRegistered bool
 
diff --git a/internal/home/config.go b/internal/home/config.go
index 3465c26f..80871665 100644
--- a/internal/home/config.go
+++ b/internal/home/config.go
@@ -168,19 +168,19 @@ var config = &configuration{
 	BindPort:     3000,
 	BetaBindPort: 0,
 	BindHost:     net.IP{0, 0, 0, 0},
-	AuthAttempts: 5,
-	AuthBlockMin: 15,
+	AuthAttempts: 3,
+	AuthBlockMin: 60,
 	DNS: dnsConfig{
 		BindHosts:     []net.IP{{0, 0, 0, 0}},
 		Port:          defaultPortDNS,
 		StatsInterval: 1,
 		FilteringConfig: dnsforward.FilteringConfig{
 			ProtectionEnabled:  true,      // whether or not use any of filtering features
-			BlockingMode:       "default", // mode how to answer filtered requests
-			BlockedResponseTTL: 10,        // in seconds
-			Ratelimit:          20,
+			BlockingMode:       "refused", // mode how to answer filtered requests
+			BlockedResponseTTL: 3600,        // in seconds
+			Ratelimit:          1000,
 			RefuseAny:          true,
-			AllServers:         false,
+			AllServers:         true,
 			FastestTimeout: timeutil.Duration{
 				Duration: fastip.DefaultPingWaitTimeout,
 			},
@@ -191,10 +191,10 @@ var config = &configuration{
 			// we introduced a default limit due to this:
 			// https://github.com/AdguardTeam/AdGuardHome/issues/2015#issuecomment-674041912
 			// was later increased to 300 due to https://github.com/AdguardTeam/AdGuardHome/issues/2257
-			MaxGoroutines: 300,
+			MaxGoroutines: 1000,
 		},
-		FilteringEnabled:           true, // whether or not use filter lists
-		FiltersUpdateIntervalHours: 24,
+		FilteringEnabled:           false, // whether or not use filter lists
+		FiltersUpdateIntervalHours: 1,
 		UpstreamTimeout:            timeutil.Duration{Duration: dnsforward.DefaultTimeout},
 		LocalDomainName:            "lan",
 		ResolveClients:             true,
@@ -206,11 +206,11 @@ var config = &configuration{
 		PortDNSOverQUIC: defaultPortQUIC,
 	},
 	logSettings: logSettings{
-		LogCompress:   false,
-		LogLocalTime:  false,
-		LogMaxBackups: 0,
-		LogMaxSize:    100,
-		LogMaxAge:     3,
+		LogCompress:   true,
+		LogLocalTime:  true,
+		LogMaxBackups: 3,
+		LogMaxSize:    64,
+		LogMaxAge:     7,
 	},
 	OSConfig:      &osConfig{},
 	SchemaVersion: currentSchemaVersion,
@@ -218,18 +218,18 @@ var config = &configuration{
 
 // initConfig initializes default configuration for the current OS&ARCH
 func initConfig() {
-	config.WebSessionTTLHours = 30 * 24
+	config.WebSessionTTLHours = 1
 
 	config.DNS.QueryLogEnabled = true
 	config.DNS.QueryLogFileEnabled = true
-	config.DNS.QueryLogInterval = timeutil.Duration{Duration: 90 * timeutil.Day}
-	config.DNS.QueryLogMemSize = 1000
-
-	config.DNS.CacheSize = 4 * 1024 * 1024
-	config.DNS.DnsfilterConf.SafeBrowsingCacheSize = 1 * 1024 * 1024
-	config.DNS.DnsfilterConf.SafeSearchCacheSize = 1 * 1024 * 1024
-	config.DNS.DnsfilterConf.ParentalCacheSize = 1 * 1024 * 1024
-	config.DNS.DnsfilterConf.CacheTime = 30
+	config.DNS.QueryLogInterval = timeutil.Duration{Duration: 7 * timeutil.Day}
+	config.DNS.QueryLogMemSize = 0
+
+	config.DNS.CacheSize = 64 * 1024 * 1024
+	config.DNS.DnsfilterConf.SafeBrowsingCacheSize = 64 * 1024 * 1024
+	config.DNS.DnsfilterConf.SafeSearchCacheSize = 64 * 1024 * 1024
+	config.DNS.DnsfilterConf.ParentalCacheSize = 64 * 1024 * 1024
+	config.DNS.DnsfilterConf.CacheTime = 3600
 	config.Filters = defaultFilters()
 
 	config.DHCP.Conf4.LeaseDuration = dhcpd.DefaultDHCPLeaseTTL
diff --git a/internal/home/dns.go b/internal/home/dns.go
index 4b120581..78d3b9dc 100644
--- a/internal/home/dns.go
+++ b/internal/home/dns.go
@@ -24,7 +24,7 @@ const (
 	defaultPortDNS   = 53
 	defaultPortHTTP  = 80
 	defaultPortHTTPS = 443
-	defaultPortQUIC  = 784
+	defaultPortQUIC  = 8853
 	defaultPortTLS   = 853
 )
 
diff --git a/internal/home/filter.go b/internal/home/filter.go
index 74f85356..5c122b73 100644
--- a/internal/home/filter.go
+++ b/internal/home/filter.go
@@ -57,10 +57,7 @@ func (f *Filtering) Close() {
 }
 
 func defaultFilters() []filter {
-	return []filter{
-		{Filter: filtering.Filter{ID: 1}, Enabled: true, URL: "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt", Name: "AdGuard DNS filter"},
-		{Filter: filtering.Filter{ID: 2}, Enabled: false, URL: "https://adaway.org/hosts.txt", Name: "AdAway Default Blocklist"},
-	}
+	return []filter{}
 }
 
 // field ordering is important -- yaml fields will mirror ordering from here
-- 
2.34.0

